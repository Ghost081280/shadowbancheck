<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5-Factor Engine Test</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0f;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #00d4ff; margin-bottom: 5px; }
        h2 { color: #ff6b35; margin-top: 30px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        h3 { color: #9d4edd; margin-top: 20px; }
        
        .status-bar {
            background: #1a1a2e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #00d4ff;
        }
        .status-bar.success { border-left-color: #00ff88; }
        .status-bar.error { border-left-color: #ff4757; }
        
        .test-input {
            background: #1a1a2e;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .test-input label { display: block; margin-bottom: 5px; color: #888; }
        .test-input input, .test-input select, .test-input textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #0a0a0f;
            color: #e0e0e0;
            margin-bottom: 15px;
            font-family: inherit;
        }
        .test-input textarea { min-height: 80px; resize: vertical; }
        
        button {
            background: linear-gradient(135deg, #00d4ff, #9d4edd);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover { opacity: 0.9; }
        button.secondary { background: #333; }
        
        .agent-result {
            background: #0a0a0f;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #666;
        }
        .agent-result.good { border-left-color: #00ff88; }
        .agent-result.warning { border-left-color: #ffa502; }
        .agent-result.danger { border-left-color: #ff4757; }
        
        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .agent-name { font-weight: 600; color: #00d4ff; }
        .agent-score { font-size: 24px; font-weight: bold; }
        .score-good { color: #00ff88; }
        .score-warning { color: #ffa502; }
        .score-danger { color: #ff4757; }
        
        .findings { margin-top: 10px; }
        .finding {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 14px;
        }
        .finding.good { background: rgba(0, 255, 136, 0.1); color: #00ff88; }
        .finding.warning { background: rgba(255, 165, 2, 0.1); color: #ffa502; }
        .finding.danger { background: rgba(255, 71, 87, 0.1); color: #ff4757; }
        .finding.info { background: rgba(0, 212, 255, 0.1); color: #00d4ff; }
        
        .verdict-box {
            background: linear-gradient(135deg, #1a1a2e, #2a1a3e);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            margin: 20px 0;
        }
        .verdict-score { font-size: 64px; font-weight: bold; margin-bottom: 10px; }
        .verdict-label { font-size: 24px; font-weight: 600; margin-bottom: 5px; }
        .verdict-desc { color: #888; }
        
        .recommendations {
            background: #0a0a0f;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .recommendation {
            padding: 10px;
            margin: 8px 0;
            border-radius: 4px;
            background: #1a1a2e;
        }
        .recommendation .priority {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 10px;
        }
        .priority.critical { background: #ff4757; color: white; }
        .priority.high { background: #ffa502; color: black; }
        .priority.medium { background: #00d4ff; color: black; }
        .priority.low { background: #666; color: white; }
        .priority.info { background: #00ff88; color: black; }
        
        .presets { margin-bottom: 15px; }
        .preset-btn { background: #333; padding: 8px 15px; font-size: 14px; }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        .loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .db-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .db-stat {
            background: #0a0a0f;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .db-stat .count { font-size: 28px; font-weight: bold; color: #00d4ff; }
        .db-stat .label { color: #888; font-size: 13px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç 5-Factor Shadowban Detection Engine</h1>
        <p style="color: #888; margin-top: 0;">Complete integration test with all 5 agents and databases</p>
        
        <div id="loadStatus" class="status-bar">Loading components...</div>
        <div id="dbStats" class="db-stats" style="display: none;"></div>
        
        <h2>Test Input</h2>
        
        <div class="presets">
            <button class="preset-btn" onclick="loadPreset('spam')">üö´ Heavy Spam</button>
            <button class="preset-btn" onclick="loadPreset('shadowban')">üëª Shadowbanned</button>
            <button class="preset-btn" onclick="loadPreset('reddit')">ü§ñ Reddit New</button>
            <button class="preset-btn" onclick="loadPreset('clean')">‚úÖ Clean</button>
        </div>
        
        <div class="test-input">
            <label>Platform</label>
            <select id="platform">
                <option value="twitter">Twitter / X</option>
                <option value="reddit">Reddit</option>
                <option value="instagram">Instagram</option>
                <option value="tiktok">TikTok</option>
            </select>
            
            <label>Username</label>
            <input type="text" id="username" placeholder="@username">
            
            <label>Post ID (optional)</label>
            <input type="text" id="postId" placeholder="Tweet ID or Post ID">
            
            <label>Content to Analyze</label>
            <textarea id="content" placeholder="Paste tweet/post content here..."></textarea>
            
            <label>URLs (one per line)</label>
            <textarea id="urls" placeholder="https://example.com" style="min-height: 60px;"></textarea>
            
            <button onclick="runAnalysis()">üîç Run Full Analysis</button>
            <button class="secondary" onclick="clearResults()">Clear</button>
        </div>
        
        <div id="resultsContainer" style="display: none;">
            <h2>Analysis Results</h2>
            <div id="results"></div>
        </div>
    </div>
    
    <!-- ============================================ -->
    <!-- LOAD ORDER MATTERS! -->
    <!-- This file lives in: js/detection/ -->
    <!-- ============================================ -->
    
    <!-- Databases (from databases/ subfolder) -->
    <script src="databases/flagged-hashtags.js"></script>
    <script src="databases/flagged-links.js"></script>
    <script src="databases/flagged-content.js"></script>
    <script src="databases/flagged-mentions.js"></script>
    <script src="databases/flagged-emojis.js"></script>
    
    <!-- Platforms (from platforms/ subfolder) -->
    <script src="platforms/twitter.js"></script>
    <script src="platforms/reddit.js"></script>
    
    <!-- Agent System (from agents/ subfolder) -->
    <script src="agents/agent-base.js"></script>
    <script src="agents/agent-platform-api.js"></script>
    <script src="agents/agent-web-analysis.js"></script>
    <script src="agents/agent-historical.js"></script>
    <script src="agents/agent-detection.js"></script>
    <script src="agents/agent-predictive.js"></script>
    
    <!-- Main engine (same folder as this HTML) -->
    <script src="5-factor-engine.js"></script>
    
    <script>
        const PRESETS = {
            spam: {
                platform: 'twitter',
                username: 'spamuser123',
                postId: '1234567890111',
                content: 'Follow me! #followback #f4f #teamfollowback! BUY NOW! üí∞üöÄüî• Limited time! @botuser12345',
                urls: 'https://bit.ly/spam\nhttps://facebook.com/page'
            },
            shadowban: {
                platform: 'twitter',
                username: 'shadowbanned_user',
                postId: '9876543210222',
                content: 'Check out my article! https://substack.com/mypost #tech',
                urls: 'https://substack.com/mypost'
            },
            reddit: {
                platform: 'reddit',
                username: 'newuser_promo',
                postId: 'abc333',
                content: 'Just made this project, check it out at https://bit.ly/myproject! u/spambot123',
                urls: 'https://bit.ly/myproject'
            },
            clean: {
                platform: 'twitter',
                username: 'healthy_account',
                postId: '5555555550000',
                content: 'Just shared my thoughts on tech trends. What do you think? #tech',
                urls: ''
            }
        };
        
        function loadPreset(name) {
            const p = PRESETS[name];
            if (!p) return;
            document.getElementById('platform').value = p.platform;
            document.getElementById('username').value = p.username;
            document.getElementById('postId').value = p.postId;
            document.getElementById('content').value = p.content;
            document.getElementById('urls').value = p.urls;
        }
        
        function checkLoadStatus() {
            const status = document.getElementById('loadStatus');
            const dbStatsEl = document.getElementById('dbStats');
            
            const components = {
                'Hashtags DB': !!window.FlaggedHashtags,
                'Links DB': !!window.FlaggedLinks,
                'Content DB': !!window.FlaggedContent,
                'Mentions DB': !!window.FlaggedMentions,
                'Emojis DB': !!window.FlaggedEmojis,
                'Twitter': !!window.twitterPlatform,
                'Reddit': !!window.redditPlatform,
                'Registry': !!window.AgentRegistry
            };
            
            const loaded = Object.values(components).filter(Boolean).length;
            const total = Object.keys(components).length;
            
            if (loaded === total) {
                status.className = 'status-bar success';
                const agentStatus = window.AgentRegistry?.getStatus();
                status.innerHTML = `‚úÖ All ${total} components loaded! ${agentStatus?.agentCount || 0} agents ready.`;
                
                dbStatsEl.style.display = 'grid';
                dbStatsEl.innerHTML = `
                    <div class="db-stat"><div class="count">${window.FlaggedHashtags?.getStats()?.twitter?.banned || 0}</div><div class="label">Banned Tags</div></div>
                    <div class="db-stat"><div class="count">${window.FlaggedLinks?.getStats()?.shorteners || 0}</div><div class="label">Shorteners</div></div>
                    <div class="db-stat"><div class="count">${window.FlaggedContent?.getStats()?.bannedTerms || 0}</div><div class="label">Banned Terms</div></div>
                    <div class="db-stat"><div class="count">${window.FlaggedMentions?.getStats()?.botPatterns || 0}</div><div class="label">Bot Patterns</div></div>
                    <div class="db-stat"><div class="count">${window.FlaggedEmojis?.getStats()?.riskyEmojis || 0}</div><div class="label">Risky Emojis</div></div>
                `;
            } else {
                status.className = 'status-bar error';
                const missing = Object.entries(components).filter(([_, l]) => !l).map(([n]) => n);
                status.innerHTML = `‚ö†Ô∏è ${loaded}/${total} loaded. Missing: ${missing.join(', ')}`;
            }
        }
        
        async function runAnalysis() {
            const container = document.getElementById('resultsContainer');
            const resultsEl = document.getElementById('results');
            
            container.style.display = 'block';
            resultsEl.innerHTML = '<div class="loading"><div class="spinner"></div>Running all 5 agents...</div>';
            
            const input = {
                platform: document.getElementById('platform').value,
                username: document.getElementById('username').value,
                postId: document.getElementById('postId').value,
                text: document.getElementById('content').value,
                content: document.getElementById('content').value,
                urls: document.getElementById('urls').value.split('\n').filter(u => u.trim())
            };
            
            try {
                const results = await window.AgentRegistry.runAll(input);
                renderResults(results);
            } catch (error) {
                resultsEl.innerHTML = `<div class="agent-result danger"><div class="agent-name">‚ùå Error</div><div class="finding danger">${error.message}</div></div>`;
            }
        }
        
        function renderResults(results) {
            const resultsEl = document.getElementById('results');
            let html = '';
            
            const predictive = results.find(r => r.agentId === 'predictive');
            
            if (predictive?.predictions) {
                const score = predictive.predictions.probability;
                const cls = score <= 20 ? 'score-good' : score <= 50 ? 'score-warning' : 'score-danger';
                html += `
                    <div class="verdict-box">
                        <div class="verdict-score ${cls}">${score}%</div>
                        <div class="verdict-label">${predictive.predictions.verdict}</div>
                        <div class="verdict-desc">${predictive.predictions.verdictDescription}</div>
                        <div style="margin-top:15px;color:#888;">
                            Reach: ${predictive.predictions.reachScore}% | Confidence: ${predictive.predictions.confidence}%<br>
                            Recovery: ${predictive.predictions.recoveryTimeline}
                        </div>
                    </div>`;
            }
            
            html += '<h3>Agent Breakdown</h3>';
            
            for (const r of results.sort((a, b) => (a.factor || 0) - (b.factor || 0))) {
                const score = r.rawScore || 0;
                const cls = score <= 20 ? 'good' : score <= 50 ? 'warning' : 'danger';
                const scoreCls = score <= 20 ? 'score-good' : score <= 50 ? 'score-warning' : 'score-danger';
                
                html += `<div class="agent-result ${cls}">
                    <div class="agent-header">
                        <span class="agent-name">Factor ${r.factor}: ${r.agent}</span>
                        <span class="agent-score ${scoreCls}">${score}</span>
                    </div>
                    <div style="color:#888;font-size:14px;margin-bottom:10px;">
                        Weighted: ${r.weightedScore} (${r.weight}%) | Confidence: ${r.confidence}% | ${r.status}
                    </div>`;
                
                if (r.findings?.length) {
                    html += '<div class="findings">';
                    for (const f of r.findings) {
                        const fc = f.type || 'info';
                        const icon = fc === 'danger' ? '‚ùå' : fc === 'warning' ? '‚ö†Ô∏è' : fc === 'good' ? '‚úÖ' : '‚ÑπÔ∏è';
                        html += `<div class="finding ${fc}">${icon} ${f.message || ''}</div>`;
                    }
                    html += '</div>';
                }
                html += '</div>';
            }
            
            if (predictive?.recommendations?.length) {
                html += '<h3>Recommendations</h3><div class="recommendations">';
                for (const rec of predictive.recommendations) {
                    html += `<div class="recommendation">
                        <span class="priority ${rec.priority}">${rec.priority.toUpperCase()}</span>
                        <strong>${rec.action}</strong>
                        <div style="color:#888;font-size:14px;margin-top:5px;">${rec.reason}</div>
                    </div>`;
                }
                html += '</div>';
            }
            
            resultsEl.innerHTML = html;
        }
        
        function clearResults() {
            document.getElementById('resultsContainer').style.display = 'none';
        }
        
        setTimeout(checkLoadStatus, 500);
    </script>
</body>
</html>
