<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engine Test - ShadowBanCheck.io</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #0a0a0a; color: #e0e0e0; }
        h1 { color: #ff6b35; }
        h2 { color: #ffa500; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .test-section { background: #1a1a1a; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .pass { color: #4ade80; }
        .fail { color: #f87171; }
        .info { color: #60a5fa; }
        pre { background: #0d0d0d; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px; max-height: 300px; }
        button { background: #ff6b35; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; margin: 5px; }
        button:hover { background: #ff8c5a; }
        input, textarea { background: #0d0d0d; border: 1px solid #333; color: #e0e0e0; padding: 10px; border-radius: 4px; width: 100%; margin: 10px 0; box-sizing: border-box; }
        textarea { height: 80px; font-family: monospace; }
        .result { margin-top: 20px; }
        .score-box { display: inline-block; padding: 10px 20px; border-radius: 6px; font-weight: bold; font-size: 24px; margin: 10px 0; }
        .score-low { background: #166534; }
        .score-medium { background: #ca8a04; }
        .score-high { background: #dc2626; }
    </style>
</head>
<body>
    <h1>üî• ShadowBanCheck Engine Test</h1>
    <p>Testing the 3 critical files: demo-data.js, 5-factor-engine.js, agent-detection.js</p>
    
    <div class="test-section">
        <h2>1. File Load Status</h2>
        <div id="load-status">Checking...</div>
    </div>
    
    <div class="test-section">
        <h2>2. Demo Data Test</h2>
        <button onclick="testDemoData()">Run Demo Data Test</button>
        <div id="demo-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Detection Agent Test</h2>
        <textarea id="test-text">Check out my new project! #followback #crypto #tech https://bit.ly/myproject</textarea>
        <button onclick="testDetectionAgent()">Test Detection Agent</button>
        <div id="detection-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Full Engine Test</h2>
        <input type="text" id="test-url" value="https://x.com/demo_user/status/1234567890">
        <button onclick="testFullEngine()">Run Power Check</button>
        <div id="engine-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>5. 3-Point Intelligence Check</h2>
        <button onclick="verify3Point()">Verify 3-Point Format</button>
        <div id="threepoint-result" class="result"></div>
    </div>

<script>
// ============================================================================
// AGENT BASE STUB
// ============================================================================
window.AgentBase = class AgentBase {
    constructor(id, factor, weight) {
        this.id = id;
        this.factorNumber = factor;
        this.weight = weight;
        this.useDemo = true;
    }
    setDemoMode(demo) { this.useDemo = demo; }
    log(msg) { console.log(`[${this.id}] ${msg}`); }
    createResult(data) { return { agentId: this.id, factorNumber: this.factorNumber, weight: this.weight, ...data }; }
    createFinding(id, message, score, details) { return { id, message, score, details, type: score > 50 ? 'danger' : score > 20 ? 'warning' : 'info' }; }
};

window.AgentRegistry = {
    agents: {},
    register(agent) { this.agents[agent.id] = agent; },
    getAll() { return this.agents; },
    async runAll(input) {
        const results = [];
        for (const agent of Object.values(this.agents)) {
            if (agent.analyze) results.push(await agent.analyze(input));
        }
        return results;
    }
};
</script>

<script>
// ============================================================================
// DEMO-DATA.JS (INLINE)
// ============================================================================
(function() {
'use strict';

function calculate3PointScore(predictiveScore, realtimeScore, historicalScore) {
    const predictive = { weight: 15, score: predictiveScore, contribution: (predictiveScore * 15) / 100 };
    const realtime = { weight: 55, score: realtimeScore, contribution: (realtimeScore * 55) / 100 };
    const historical = { weight: 30, score: historicalScore, contribution: (historicalScore * 30) / 100 };
    return { predictive, realtime, historical, combinedScore: Math.round((predictive.contribution + realtime.contribution + historical.contribution) * 100) / 100 };
}

function getConfidenceLevel(score, activeSourceCount) {
    const agreementBonus = activeSourceCount >= 3 ? 15 : activeSourceCount >= 2 ? 5 : 0;
    const adjustedScore = Math.min(100, score + agreementBonus);
    let level = adjustedScore >= 70 ? 'high' : adjustedScore >= 40 ? 'medium' : 'low';
    let description = activeSourceCount >= 3 ? '3+ sources corroborate' : activeSourceCount >= 2 ? '2 sources corroborate' : 'Single source';
    return { level, score: adjustedScore, sources: activeSourceCount, description };
}

const PLATFORM_MODULES = {
    twitter: { total: 21, hashtags: 4, cashtags: 3, links: 4, content: 4, mentions: 3, emojis: 3 },
    reddit: { total: 14, hashtags: 0, cashtags: 0, links: 4, content: 4, mentions: 3, emojis: 3 }
};

const DemoScenarios = {
    twitter_moderate_issues: {
        meta: { scenarioId: 'twitter_moderate_issues', platform: 'twitter', expectedProbability: 45 },
        powerCheck: function() {
            const timestamp = new Date().toISOString();
            const platformModules = PLATFORM_MODULES.twitter;
            return {
                checkType: 'powerCheck',
                platform: 'twitter',
                timestamp: timestamp,
                demo: true,
                post: { id: '1234567890', exists: true, reachScore: 55, probability: 45, verdict: 'LIKELY RESTRICTED' },
                account: { username: 'demo_user_1', exists: true, suspended: false, probability: 40, verdict: 'LIKELY RESTRICTED' },
                agents: [
                    { agent: 'API Agent', agentId: 'api', factor: 1, weight: 20, status: 'complete', rawScore: 15, weightedScore: 3, confidence: 85, findings: [{ type: 'good', message: 'Account exists' }] },
                    { agent: 'Web Analysis Agent', agentId: 'web', factor: 2, weight: 20, status: 'complete', rawScore: 55, weightedScore: 11, confidence: 80, findings: [{ type: 'danger', message: 'Search suggestion ban detected' }] },
                    { agent: 'Historical Agent', agentId: 'historical', factor: 3, weight: 15, status: 'complete', rawScore: 30, weightedScore: 4.5, confidence: 75, findings: [{ type: 'warning', message: 'Score worsening' }] },
                    {
                        agent: 'Detection Agent',
                        agentId: 'detection',
                        factor: 4,
                        weight: 25,
                        status: 'complete',
                        modulesActive: platformModules.total,
                        signals: {
                            hashtags: {
                                signalType: 'hashtags',
                                moduleCount: 4,
                                enabled: true,
                                threePoint: {
                                    predictive: { weight: 15, score: 60, contribution: 9, sources: ['Reddit reports'] },
                                    realtime: { weight: 55, score: 85, contribution: 46.75, sources: ['API check', 'Web test'] },
                                    historical: { weight: 30, score: 70, contribution: 21, sources: ['Database'] }
                                },
                                combinedScore: 76.75,
                                checked: ['#followback', '#crypto', '#tech'],
                                flagged: { banned: [{ tag: '#followback', reason: 'Follow-for-follow schemes' }], restricted: [], monitored: [] },
                                safe: ['#crypto', '#tech'],
                                confidence: getConfidenceLevel(76.75, 3)
                            },
                            cashtags: { signalType: 'cashtags', moduleCount: 3, enabled: true, threePoint: { predictive: { weight: 15, score: 0, contribution: 0 }, realtime: { weight: 55, score: 0, contribution: 0 }, historical: { weight: 30, score: 0, contribution: 0 } }, combinedScore: 0, checked: [], flagged: {}, safe: [], confidence: getConfidenceLevel(0, 1) },
                            links: { signalType: 'links', moduleCount: 4, enabled: true, threePoint: { predictive: { weight: 15, score: 40, contribution: 6 }, realtime: { weight: 55, score: 35, contribution: 19.25 }, historical: { weight: 30, score: 20, contribution: 6 } }, combinedScore: 31.25, checked: ['https://bit.ly/myproject'], flagged: { shorteners: [{ url: 'bit.ly' }] }, safe: [], confidence: getConfidenceLevel(31.25, 3) },
                            content: { signalType: 'content', moduleCount: 4, enabled: true, threePoint: { predictive: { weight: 15, score: 10, contribution: 1.5 }, realtime: { weight: 55, score: 5, contribution: 2.75 }, historical: { weight: 30, score: 0, contribution: 0 } }, combinedScore: 4.25, flagged: {}, confidence: getConfidenceLevel(4.25, 2) },
                            mentions: { signalType: 'mentions', moduleCount: 3, enabled: true, threePoint: { predictive: { weight: 15, score: 0, contribution: 0 }, realtime: { weight: 55, score: 0, contribution: 0 }, historical: { weight: 30, score: 0, contribution: 0 } }, combinedScore: 0, checked: [], flagged: {}, safe: [], confidence: getConfidenceLevel(0, 1) },
                            emojis: { signalType: 'emojis', moduleCount: 3, enabled: true, threePoint: { predictive: { weight: 15, score: 0, contribution: 0 }, realtime: { weight: 55, score: 0, contribution: 0 }, historical: { weight: 30, score: 0, contribution: 0 } }, combinedScore: 0, checked: [], flagged: {}, safe: [], confidence: getConfidenceLevel(0, 1) }
                        },
                        signalSummary: { totalSignals: 6, activeSignals: 6, flaggedSignals: 2, scores: { hashtags: 76.75, cashtags: 0, links: 31.25, content: 4.25, mentions: 0, emojis: 0 }, averageScore: 28.06 },
                        findings: [{ type: 'danger', message: 'Banned hashtag #followback detected' }, { type: 'warning', message: 'Link shortener detected' }],
                        rawScore: 50,
                        weightedScore: 12.5,
                        confidence: 85
                    },
                    { agent: 'Predictive AI Agent', agentId: 'predictive', factor: 5, weight: 20, status: 'complete', rawScore: 45, weightedScore: 9, confidence: 78, findings: [{ type: 'danger', message: '3 risk factors detected' }] }
                ],
                synthesis: { probability: 45, reachScore: 55, confidence: { level: 'high', score: 78, sources: 4 }, verdict: 'LIKELY RESTRICTED', primaryIssues: ['Search suggestion ban', 'Banned hashtag'] },
                recommendations: [{ priority: 'critical', action: 'Remove #followback' }, { priority: 'high', action: 'Replace bit.ly link' }]
            };
        }
    }
};

window.DemoData = {
    version: '3.0.0',
    scenarios: DemoScenarios,
    platformModules: PLATFORM_MODULES,
    getScenarioResult: function(scenarioId, checkType) {
        const scenario = DemoScenarios[scenarioId];
        if (!scenario || !scenario[checkType]) return null;
        return scenario[checkType]();
    },
    getScenarioIds: function() { return Object.keys(DemoScenarios); },
    calculate3Point: calculate3PointScore,
    getConfidence: getConfidenceLevel
};

console.log('‚úÖ DemoData v3.0 loaded');
})();
</script>

<script>
// ============================================================================
// 5-FACTOR-ENGINE.JS (INLINE - SIMPLIFIED)
// ============================================================================
(function() {
'use strict';

class FiveFactorEngine {
    constructor() {
        this.version = '2.0.0';
        this.useDemo = true;
        this.factorWeights = { 1: 20, 2: 20, 3: 15, 4: 25, 5: 20 };
    }
    
    async powerCheck(url) {
        const startTime = Date.now();
        const platform = this.detectPlatform(url);
        if (!platform) return { error: true, message: 'Invalid URL' };
        
        const input = { type: 'post', platform: platform, url: url, text: '' };
        const agentResults = await this.runAllFactors(input);
        const synthesis = this.synthesizeResults(agentResults);
        
        return {
            checkType: 'powerCheck',
            platform: platform,
            inputUrl: url,
            timestamp: new Date().toISOString(),
            processingTime: Date.now() - startTime,
            demo: this.useDemo,
            agents: agentResults.map(r => this.formatAgentOutput(r)),
            synthesis: {
                probability: synthesis.probability,
                reachScore: 100 - synthesis.probability,
                confidence: { level: synthesis.confidence >= 70 ? 'high' : 'medium', score: synthesis.confidence, sources: agentResults.length },
                verdict: synthesis.verdict,
                primaryIssues: synthesis.primaryIssues
            },
            recommendations: [{ priority: 'info', action: 'Analysis complete' }]
        };
    }
    
    async runAllFactors(input) {
        if (window.AgentRegistry) {
            return await window.AgentRegistry.runAll(input);
        }
        return [];
    }
    
    synthesizeResults(agentResults) {
        let weightedTotal = 0, weightSum = 0, confidenceSum = 0, confidenceCount = 0;
        const primaryIssues = [];
        
        for (const result of agentResults) {
            const weight = result.weight || 20;
            weightedTotal += (result.rawScore || 0) * weight;
            weightSum += weight;
            if (result.confidence) { confidenceSum += result.confidence; confidenceCount++; }
            if (result.findings) {
                for (const f of result.findings) {
                    if (f.type === 'danger') primaryIssues.push(f.message);
                }
            }
        }
        
        const probability = weightSum > 0 ? Math.round(weightedTotal / weightSum) : 0;
        const confidence = confidenceCount > 0 ? Math.round(confidenceSum / confidenceCount) : 50;
        const verdict = probability <= 15 ? 'CLEAR' : probability <= 30 ? 'LIKELY CLEAR' : probability <= 50 ? 'UNCERTAIN' : probability <= 70 ? 'LIKELY RESTRICTED' : 'RESTRICTED';
        
        return { probability, confidence, verdict, primaryIssues };
    }
    
    formatAgentOutput(result) {
        const output = { agent: result.agent, agentId: result.agentId, factor: result.factorNumber || result.factor, weight: result.weight, status: result.status, rawScore: result.rawScore, weightedScore: result.weightedScore, confidence: result.confidence, findings: result.findings || [] };
        if (result.factorNumber === 4 || result.agentId === 'detection') {
            output.modulesActive = result.modulesActive;
            output.signals = result.signals;
            output.signalSummary = result.signalSummary;
        }
        return output;
    }
    
    detectPlatform(url) {
        if (!url) return null;
        const lower = url.toLowerCase();
        if (lower.includes('twitter.com') || lower.includes('x.com')) return 'twitter';
        if (lower.includes('reddit.com')) return 'reddit';
        return null;
    }
    
    setDemoMode(demo) { this.useDemo = demo; }
    getStatus() { return { version: this.version, useDemo: this.useDemo }; }
}

const engine = new FiveFactorEngine();
window.FiveFactorEngine = FiveFactorEngine;
window.shadowBanEngine = engine;
window.powerCheck = (url) => engine.powerCheck(url);

console.log('‚úÖ 5-Factor Engine v2.0 loaded');
})();
</script>

<script>
// ============================================================================
// AGENT-DETECTION.JS (INLINE - SIMPLIFIED)
// ============================================================================
(function() {
'use strict';

const PLATFORM_MODULES = {
    twitter: { total: 21, hashtags: 4, cashtags: 3, links: 4, content: 4, mentions: 3, emojis: 3 },
    reddit: { total: 14, hashtags: 0, cashtags: 0, links: 4, content: 4, mentions: 3, emojis: 3 }
};

const THREE_POINT_WEIGHTS = { predictive: 15, realtime: 55, historical: 30 };

class DetectionAgent extends window.AgentBase {
    constructor() {
        super('detection', 4, 25);
    }
    
    async analyze(input) {
        const startTime = Date.now();
        const platform = input.platform || 'twitter';
        const platformModules = PLATFORM_MODULES[platform] || PLATFORM_MODULES.twitter;
        const timestamp = new Date().toISOString();
        const text = input.text || '';
        
        if (!text) {
            return this.createEmptyResult(platformModules, timestamp, startTime);
        }
        
        const signals = {
            hashtags: this.analyzeHashtags(text, platform, platformModules, timestamp),
            cashtags: this.analyzeCashtags(text, platform, platformModules, timestamp),
            links: this.analyzeLinks(text, platform, platformModules, timestamp),
            content: this.analyzeContent(text, platform, platformModules, timestamp),
            mentions: this.analyzeMentions(text, platform, platformModules, timestamp),
            emojis: this.analyzeEmojis(text, platform, platformModules, timestamp)
        };
        
        const signalSummary = this.buildSignalSummary(signals);
        const findings = this.generateFindings(signals);
        const { rawScore, confidence } = this.calculateOverallScore(signals);
        
        return {
            agentId: 'detection',
            agent: 'Detection Agent',
            factorNumber: 4,
            factor: 4,
            factorName: 'Real-Time Detection',
            weight: 25,
            status: 'complete',
            modulesActive: platformModules.total,
            signals: signals,
            signalSummary: signalSummary,
            findings: findings,
            rawScore: rawScore,
            weightedScore: Math.round((rawScore * 25) / 100 * 100) / 100,
            confidence: confidence,
            timestamp: timestamp,
            processingTime: Date.now() - startTime,
            demo: this.useDemo
        };
    }
    
    calculate3PointScore(predictiveScore, realtimeScore, historicalScore) {
        const predictive = { weight: 15, score: predictiveScore, contribution: Math.round((predictiveScore * 15) / 100 * 100) / 100 };
        const realtime = { weight: 55, score: realtimeScore, contribution: Math.round((realtimeScore * 55) / 100 * 100) / 100 };
        const historical = { weight: 30, score: historicalScore, contribution: Math.round((historicalScore * 30) / 100 * 100) / 100 };
        const combinedScore = Math.round((predictive.contribution + realtime.contribution + historical.contribution) * 100) / 100;
        return { predictive, realtime, historical, combinedScore };
    }
    
    getConfidenceLevel(score, sources) {
        const bonus = sources >= 3 ? 15 : sources >= 2 ? 5 : 0;
        const adjusted = Math.min(100, score + bonus);
        return { level: adjusted >= 70 ? 'high' : adjusted >= 40 ? 'medium' : 'low', score: adjusted, sources: sources };
    }
    
    analyzeHashtags(text, platform, platformModules, timestamp) {
        const moduleCount = platformModules.hashtags;
        if (moduleCount === 0) return this.createDisabledSignal('hashtags', platform);
        
        const found = text.match(/#[\w]+/g) || [];
        let realtimeScore = 0, predictiveScore = 0, historicalScore = 0;
        const banned = [], safe = [];
        const sources = [];
        
        // Check for known banned hashtags
        const bannedTags = ['#followback', '#follow4follow', '#f4f', '#l4l', '#teamfollowback'];
        for (const tag of found) {
            if (bannedTags.includes(tag.toLowerCase())) {
                banned.push({ tag: tag, reason: 'Engagement manipulation' });
                realtimeScore += 40;
                predictiveScore += 30;
                historicalScore += 35;
            } else {
                safe.push(tag);
            }
        }
        
        if (found.length > 0) sources.push(`Found ${found.length} hashtag(s)`);
        if (banned.length > 0) sources.push(`${banned.length} banned hashtag(s) detected`);
        
        const threePoint = this.calculate3PointScore(predictiveScore, realtimeScore, historicalScore);
        threePoint.predictive.sources = predictiveScore > 0 ? ['Community reports'] : [];
        threePoint.realtime.sources = sources;
        threePoint.historical.sources = historicalScore > 0 ? ['Database records'] : [];
        
        const activeSourceCount = [predictiveScore, realtimeScore, historicalScore].filter(s => s > 0).length || 1;
        
        return {
            signalType: 'hashtags',
            moduleCount: moduleCount,
            enabled: true,
            threePoint: threePoint,
            combinedScore: threePoint.combinedScore,
            checked: found,
            flagged: { banned: banned, restricted: [], monitored: [] },
            safe: safe,
            confidence: this.getConfidenceLevel(threePoint.combinedScore, activeSourceCount),
            lastVerified: timestamp
        };
    }
    
    analyzeCashtags(text, platform, platformModules, timestamp) {
        const moduleCount = platformModules.cashtags;
        if (moduleCount === 0) return this.createDisabledSignal('cashtags', platform);
        
        const found = text.match(/\$[A-Za-z]{1,5}/g) || [];
        const threePoint = this.calculate3PointScore(0, 0, 0);
        
        return {
            signalType: 'cashtags',
            moduleCount: moduleCount,
            enabled: true,
            threePoint: threePoint,
            combinedScore: 0,
            checked: found,
            flagged: { banned: [], restricted: [], monitored: [] },
            safe: found,
            confidence: this.getConfidenceLevel(0, 1),
            lastVerified: timestamp
        };
    }
    
    analyzeLinks(text, platform, platformModules, timestamp) {
        const found = text.match(/https?:\/\/[^\s]+/g) || [];
        let realtimeScore = 0, predictiveScore = 0, historicalScore = 0;
        const shorteners = [], throttled = [];
        const sources = [];
        
        const shortenerDomains = ['bit.ly', 'tinyurl.com', 't.co', 'goo.gl'];
        const throttledDomains = ['facebook.com', 'instagram.com', 'substack.com'];
        
        for (const url of found) {
            for (const d of shortenerDomains) {
                if (url.includes(d)) {
                    shorteners.push({ url: d, reason: 'Link shortener may reduce reach' });
                    realtimeScore += 20;
                    predictiveScore += 15;
                }
            }
            if (platform === 'twitter') {
                for (const d of throttledDomains) {
                    if (url.includes(d)) {
                        throttled.push({ domain: d, delay: 2544 });
                        realtimeScore += 25;
                    }
                }
            }
        }
        
        if (found.length > 0) sources.push(`Found ${found.length} URL(s)`);
        if (shorteners.length > 0) sources.push('Link shortener detected');
        if (throttled.length > 0) sources.push('Throttled domain detected');
        
        const threePoint = this.calculate3PointScore(predictiveScore, realtimeScore, historicalScore);
        threePoint.realtime.sources = sources.length > 0 ? sources : ['No URLs found'];
        
        const activeSourceCount = [predictiveScore, realtimeScore, historicalScore].filter(s => s > 0).length || 1;
        
        return {
            signalType: 'links',
            moduleCount: platformModules.links,
            enabled: true,
            threePoint: threePoint,
            combinedScore: threePoint.combinedScore,
            checked: found,
            flagged: { shorteners: shorteners, throttled: throttled, blocked: [] },
            safe: found.filter(u => !shorteners.some(s => u.includes(s.url))),
            confidence: this.getConfidenceLevel(threePoint.combinedScore, activeSourceCount),
            lastVerified: timestamp
        };
    }
    
    analyzeContent(text, platform, platformModules, timestamp) {
        let realtimeScore = 0;
        const patterns = [];
        const sources = ['Content scan complete'];
        
        const capsRatio = text.length > 0 ? (text.match(/[A-Z]/g) || []).length / text.length : 0;
        if (capsRatio > 0.5 && text.length > 20) {
            patterns.push({ pattern: 'excessive_caps' });
            realtimeScore += 10;
        }
        
        const threePoint = this.calculate3PointScore(0, realtimeScore, 0);
        threePoint.realtime.sources = sources;
        
        return {
            signalType: 'content',
            moduleCount: platformModules.content,
            enabled: true,
            threePoint: threePoint,
            combinedScore: threePoint.combinedScore,
            checked: [text.substring(0, 50) + '...'],
            flagged: { banned: [], restricted: [], patterns: patterns },
            confidence: this.getConfidenceLevel(threePoint.combinedScore, 1),
            lastVerified: timestamp
        };
    }
    
    analyzeMentions(text, platform, platformModules, timestamp) {
        const pattern = platform === 'reddit' ? /u\/[\w-]+/g : /@[\w]+/g;
        const found = text.match(pattern) || [];
        const threePoint = this.calculate3PointScore(0, 0, 0);
        threePoint.realtime.sources = found.length > 0 ? [`Found ${found.length} mention(s)`] : ['No mentions'];
        
        return {
            signalType: 'mentions',
            moduleCount: platformModules.mentions,
            enabled: true,
            threePoint: threePoint,
            combinedScore: 0,
            checked: found,
            flagged: { suspended: [], shadowbanned: [], bots: [] },
            safe: found,
            confidence: this.getConfidenceLevel(0, 1),
            lastVerified: timestamp
        };
    }
    
    analyzeEmojis(text, platform, platformModules, timestamp) {
        const found = text.match(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]/gu) || [];
        const threePoint = this.calculate3PointScore(0, 0, 0);
        threePoint.realtime.sources = found.length > 0 ? [`Found ${found.length} emoji(s)`] : ['No emojis'];
        
        return {
            signalType: 'emojis',
            moduleCount: platformModules.emojis,
            enabled: true,
            threePoint: threePoint,
            combinedScore: 0,
            checked: found,
            flagged: { risky: [], combinations: [] },
            safe: found,
            confidence: this.getConfidenceLevel(0, 1),
            lastVerified: timestamp
        };
    }
    
    createDisabledSignal(signalType, platform) {
        return {
            signalType: signalType,
            moduleCount: 0,
            enabled: false,
            note: `N/A for ${platform}`,
            threePoint: { predictive: { weight: 15, score: 0, contribution: 0 }, realtime: { weight: 55, score: 0, contribution: 0 }, historical: { weight: 30, score: 0, contribution: 0 } },
            combinedScore: 0,
            checked: [],
            flagged: {},
            safe: [],
            confidence: { level: 'low', score: 0, sources: 0 }
        };
    }
    
    buildSignalSummary(signals) {
        const scores = {};
        let activeSignals = 0, flaggedSignals = 0, scoreSum = 0, activeCount = 0;
        
        for (const [type, signal] of Object.entries(signals)) {
            scores[type] = signal.combinedScore;
            if (signal.enabled) {
                activeSignals++;
                if (signal.combinedScore > 0) { scoreSum += signal.combinedScore; activeCount++; }
                const flagged = signal.flagged || {};
                if (Object.values(flagged).some(arr => Array.isArray(arr) && arr.length > 0)) flaggedSignals++;
            }
        }
        
        return { totalSignals: 6, activeSignals, flaggedSignals, scores, averageScore: activeCount > 0 ? Math.round((scoreSum / activeCount) * 100) / 100 : 0 };
    }
    
    generateFindings(signals) {
        const findings = [];
        for (const [type, signal] of Object.entries(signals)) {
            if (!signal.enabled) continue;
            const flagged = signal.flagged || {};
            if (flagged.banned?.length > 0) findings.push({ type: 'danger', severity: 'high', message: `Banned ${type}: ${flagged.banned.map(b => b.tag || b.url).join(', ')}`, impact: 30 });
            if (flagged.shorteners?.length > 0) findings.push({ type: 'warning', severity: 'medium', message: 'Link shortener detected', impact: 15 });
            if (flagged.throttled?.length > 0) findings.push({ type: 'warning', severity: 'medium', message: `Throttled domain: ${flagged.throttled.map(t => t.domain).join(', ')}`, impact: 20 });
        }
        if (findings.length === 0) findings.push({ type: 'good', severity: 'none', message: 'All signals clean', impact: 0 });
        return findings;
    }
    
    calculateOverallScore(signals) {
        const weights = { hashtags: 25, cashtags: 15, links: 25, content: 20, mentions: 10, emojis: 5 };
        let weightedSum = 0, totalWeight = 0, confidenceSum = 0, confidenceCount = 0;
        
        for (const [type, signal] of Object.entries(signals)) {
            if (!signal.enabled) continue;
            const weight = weights[type] || 10;
            weightedSum += signal.combinedScore * weight;
            totalWeight += weight;
            if (signal.confidence?.score) { confidenceSum += signal.confidence.score; confidenceCount++; }
        }
        
        return { rawScore: totalWeight > 0 ? Math.round(weightedSum / totalWeight) : 0, confidence: confidenceCount > 0 ? Math.round(confidenceSum / confidenceCount) : 50 };
    }
    
    createEmptyResult(platformModules, timestamp, startTime) {
        return { agentId: 'detection', agent: 'Detection Agent', factorNumber: 4, weight: 25, status: 'complete', modulesActive: platformModules.total, signals: {}, signalSummary: { totalSignals: 0, activeSignals: 0, flaggedSignals: 0, scores: {}, averageScore: 0 }, findings: [{ type: 'info', message: 'No content to analyze' }], rawScore: 0, weightedScore: 0, confidence: 100, timestamp: timestamp, processingTime: Date.now() - startTime, demo: this.useDemo };
    }
}

const detectionAgent = new DetectionAgent();
if (window.AgentRegistry) window.AgentRegistry.register(detectionAgent);
window.DetectionAgent = DetectionAgent;
window.detectionAgent = detectionAgent;

console.log('‚úÖ DetectionAgent (Factor 4) loaded');
})();
</script>

<script>
// ============================================================================
// TEST FUNCTIONS
// ============================================================================
function checkLoadStatus() {
    const status = document.getElementById('load-status');
    let html = '';
    
    if (window.DemoData) {
        html += `<p class="pass">‚úÖ demo-data.js loaded (v${window.DemoData.version})</p>`;
        html += `<p class="info">   Scenarios: ${window.DemoData.getScenarioIds().join(', ')}</p>`;
    } else {
        html += '<p class="fail">‚ùå demo-data.js NOT loaded</p>';
    }
    
    if (window.shadowBanEngine) {
        html += `<p class="pass">‚úÖ 5-factor-engine.js loaded (v${window.shadowBanEngine.version})</p>`;
    } else {
        html += '<p class="fail">‚ùå 5-factor-engine.js NOT loaded</p>';
    }
    
    if (window.DetectionAgent && window.detectionAgent) {
        html += '<p class="pass">‚úÖ agent-detection.js loaded</p>';
    } else {
        html += '<p class="fail">‚ùå agent-detection.js NOT loaded</p>';
    }
    
    const agentCount = Object.keys(window.AgentRegistry?.agents || {}).length;
    html += `<p class="info">   Registered agents: ${agentCount}</p>`;
    
    status.innerHTML = html;
}

function testDemoData() {
    const result = document.getElementById('demo-result');
    try {
        const demo = window.DemoData.getScenarioResult('twitter_moderate_issues', 'powerCheck');
        if (!demo) { result.innerHTML = '<p class="fail">‚ùå Failed to get demo</p>'; return; }
        
        let html = '<p class="pass">‚úÖ Demo data retrieved</p>';
        const checks = [
            { name: 'Has agents array', pass: Array.isArray(demo.agents) },
            { name: 'Has 5 agents', pass: demo.agents?.length === 5 },
            { name: 'Detection Agent has signals', pass: demo.agents?.[3]?.signals !== undefined },
            { name: 'Hashtags have 3-Point', pass: demo.agents?.[3]?.signals?.hashtags?.threePoint !== undefined },
            { name: 'Has synthesis', pass: demo.synthesis !== undefined }
        ];
        for (const c of checks) html += `<p class="${c.pass ? 'pass' : 'fail'}">${c.pass ? '‚úÖ' : '‚ùå'} ${c.name}</p>`;
        
        const det = demo.agents?.[3];
        if (det?.signalSummary) {
            html += '<h3>Detection Agent Signal Summary:</h3>';
            html += `<pre>${JSON.stringify(det.signalSummary, null, 2)}</pre>`;
        }
        result.innerHTML = html;
    } catch (error) {
        result.innerHTML = `<p class="fail">‚ùå Error: ${error.message}</p>`;
    }
}

async function testDetectionAgent() {
    const result = document.getElementById('detection-result');
    const text = document.getElementById('test-text').value;
    try {
        if (!window.detectionAgent) { result.innerHTML = '<p class="fail">‚ùå Detection Agent not loaded</p>'; return; }
        
        const analysis = await window.detectionAgent.analyze({ platform: 'twitter', text: text });
        
        let html = '<p class="pass">‚úÖ Detection Agent ran successfully</p>';
        const scoreClass = analysis.rawScore > 50 ? 'score-high' : analysis.rawScore > 25 ? 'score-medium' : 'score-low';
        html += `<div class="score-box ${scoreClass}">Score: ${analysis.rawScore}</div>`;
        html += `<p>Confidence: ${analysis.confidence}%</p>`;
        html += '<h3>Signal Summary:</h3>';
        html += `<pre>${JSON.stringify(analysis.signalSummary, null, 2)}</pre>`;
        
        if (analysis.signals?.hashtags?.threePoint) {
            html += '<h3>Hashtags 3-Point Intelligence:</h3>';
            html += `<pre>${JSON.stringify(analysis.signals.hashtags.threePoint, null, 2)}</pre>`;
        }
        
        html += '<h3>Findings:</h3>';
        for (const f of analysis.findings || []) {
            const cls = f.type === 'danger' ? 'fail' : f.type === 'warning' ? 'info' : 'pass';
            html += `<p class="${cls}">${f.message}</p>`;
        }
        result.innerHTML = html;
    } catch (error) {
        result.innerHTML = `<p class="fail">‚ùå Error: ${error.message}</p><pre>${error.stack}</pre>`;
    }
}

async function testFullEngine() {
    const result = document.getElementById('engine-result');
    const url = document.getElementById('test-url').value;
    try {
        if (!window.shadowBanEngine) { result.innerHTML = '<p class="fail">‚ùå Engine not loaded</p>'; return; }
        
        const check = await window.shadowBanEngine.powerCheck(url);
        if (check.error) { result.innerHTML = `<p class="fail">‚ùå ${check.message}</p>`; return; }
        
        let html = '<p class="pass">‚úÖ Power Check completed</p>';
        html += `<h3>Verdict: ${check.synthesis?.verdict || 'N/A'}</h3>`;
        html += `<p>Probability: ${check.synthesis?.probability || 0}%</p>`;
        
        const det = check.agents?.find(a => a.factor === 4 || a.agentId === 'detection');
        if (det) {
            html += '<h3>Detection Agent Output:</h3>';
            html += `<p class="${det.signals ? 'pass' : 'fail'}">${det.signals ? '‚úÖ' : '‚ùå'} Has signals object</p>`;
            html += `<p class="${det.signalSummary ? 'pass' : 'fail'}">${det.signalSummary ? '‚úÖ' : '‚ùå'} Has signalSummary</p>`;
            if (det.signalSummary) html += `<pre>${JSON.stringify(det.signalSummary, null, 2)}</pre>`;
        }
        result.innerHTML = html;
    } catch (error) {
        result.innerHTML = `<p class="fail">‚ùå Error: ${error.message}</p>`;
    }
}

function verify3Point() {
    const result = document.getElementById('threepoint-result');
    try {
        const demo = window.DemoData.getScenarioResult('twitter_moderate_issues', 'powerCheck');
        const hashtags = demo?.agents?.[3]?.signals?.hashtags;
        if (!hashtags) { result.innerHTML = '<p class="fail">‚ùå Cannot find hashtags</p>'; return; }
        
        let html = '<h3>3-Point Intelligence Check</h3>';
        const tp = hashtags.threePoint;
        const checks = [
            { name: 'Has predictive', pass: tp?.predictive !== undefined },
            { name: 'Predictive weight = 15', pass: tp?.predictive?.weight === 15 },
            { name: 'Has realtime', pass: tp?.realtime !== undefined },
            { name: 'Realtime weight = 55', pass: tp?.realtime?.weight === 55 },
            { name: 'Has historical', pass: tp?.historical !== undefined },
            { name: 'Historical weight = 30', pass: tp?.historical?.weight === 30 },
            { name: 'Weights sum to 100', pass: (tp?.predictive?.weight + tp?.realtime?.weight + tp?.historical?.weight) === 100 },
            { name: 'Has combinedScore', pass: hashtags.combinedScore !== undefined }
        ];
        
        let allPass = true;
        for (const c of checks) {
            html += `<p class="${c.pass ? 'pass' : 'fail'}">${c.pass ? '‚úÖ' : '‚ùå'} ${c.name}</p>`;
            if (!c.pass) allPass = false;
        }
        
        if (allPass) html += '<p class="pass" style="font-size:18px;margin-top:20px;">üéâ All 3-Point checks passed!</p>';
        html += '<h3>3-Point Structure:</h3>';
        html += `<pre>${JSON.stringify(tp, null, 2)}</pre>`;
        result.innerHTML = html;
    } catch (error) {
        result.innerHTML = `<p class="fail">‚ùå Error: ${error.message}</p>`;
    }
}

window.onload = function() { setTimeout(checkLoadStatus, 100); };
</script>

</body>
</html>
